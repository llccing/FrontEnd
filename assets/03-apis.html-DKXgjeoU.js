import{_ as s,c as a,a as e,o as p}from"./app-Dbw06csz.js";const t={};function o(c,n){return p(),a("div",null,[...n[0]||(n[0]=[e(`<h1 id="译-passport-文档-三-基本-摘要" tabindex="-1"><a class="header-anchor" href="#译-passport-文档-三-基本-摘要"><span>[译]Passport 文档（三）基本 &amp; 摘要</span></a></h1><p><a href="http://www.passportjs.org/docs/downloads/html/" target="_blank" rel="noopener noreferrer">http://www.passportjs.org/docs/downloads/html/</a> 原文地址</p><p>连同定义 HTTP 的身份验证框架，<a href="http://tools.ietf.org/html/rfc2617" target="_blank" rel="noopener noreferrer">RFC 2617</a> 也定义了基本和摘要认证方案。这两种方案都使用用户名和密码作为凭证来认证用户，并且通常用于保护 API 端点。</p><p>有一点需要注意，依赖用户名和密码的凭证也能有不利的安全影响，尤其在这样的情景下，服务器和客户端之间没有高度互信的情景。这种情况下，建议使用认证框架比如 <a href="http://www.passportjs.org/guide/oauth2-api/" target="_blank" rel="noopener noreferrer">OAuth 2.0</a>。</p><p>通过提供 <a href="https://github.com/jaredhanson/passport-http" target="_blank" rel="noopener noreferrer">passport-http</a> 模块来支持基本和摘要方案</p><h3 id="安装" tabindex="-1"><a class="header-anchor" href="#安装"><span>安装</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">npm install passport<span class="token operator">-</span>http</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="基本" tabindex="-1"><a class="header-anchor" href="#基本"><span>基本</span></a></h4><p>基本方案使用用户名和密码来认证用户。这凭证将以明文方式传输，所以建议使用 HTTPS 来实施该方案。</p><h3 id="配置" tabindex="-1"><a class="header-anchor" href="#配置"><span>配置</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">passport<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BasicStrategy</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">username</span><span class="token operator">:</span> username<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">.</span><span class="token function">validPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>基本认证的验证回调接收 <code>username</code> 和 <code>password</code> 参数。</p><h3 id="保护端点" tabindex="-1"><a class="header-anchor" href="#保护端点"><span>保护端点</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/api/me&#39;</span><span class="token punctuation">,</span> </span>
<span class="line">    passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&#39;basic&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">session</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>基本</code> 策略中定义 <code>passport.authenticate()</code> 来保护 API 端点。sessions 通常不被API 需要，所以能够禁止。</p><h4 id="摘要" tabindex="-1"><a class="header-anchor" href="#摘要"><span>摘要</span></a></h4><p>摘要策略使用用户名和密码来认证用户。与基本策略相比，它的主要优势是使用挑战响应式（challenge-response ）范例来避免明文发送密码。</p><h3 id="配置-1" tabindex="-1"><a class="header-anchor" href="#配置-1"><span>配置</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">passport<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DigestStrategy</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token punctuation">{</span> <span class="token literal-property property">qop</span><span class="token operator">:</span> <span class="token string">&#39;auth&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">username<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">username</span><span class="token operator">:</span> username <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">params<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 根据需要验证随机数</span></span>
<span class="line">        <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>摘要策略利用了两个回调，第二个是可选的。</p><p>第一个回调，称为“密钥回调”，接受用户名然后调用 <code>done</code> 函数，来提供用户信息和对应的密码。密码用来计算哈希，如果和请求中携带的不符将认证失败。</p><p>第二个“验证回调”接受与随机数相关的参数，能够用来校验从而避免重播攻击。</p><h3 id="保护端点-1" tabindex="-1"><a class="header-anchor" href="#保护端点-1"><span>保护端点</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/api/me&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&#39;digest&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">session</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>摘要</code> 策略中定义 <code>passport.authenticate()</code> 来保护 API 端点。sessions 通常不被API 需要，所以能够禁止。</p><h2 id="oauth" tabindex="-1"><a class="header-anchor" href="#oauth"><span>OAuth</span></a></h2><p><a href="http://oauth.net/" target="_blank" rel="noopener noreferrer">OAuth</a>（<a href="http://tools.ietf.org/html/rfc5849" target="_blank" rel="noopener noreferrer">RFC 5849</a> 正式定义）提供了一种方法 -- 用户授权第三方应用访问他们的数据，而不需要暴露他们的密码给这个应用。</p><p>这个协议极大的改善了 web 应用的安全性，尤其是 OAuth 吸引人们注意将密码暴露给外部服务的潜在危险非常重要。</p><p>OAuth 1.0 仍然被大范围使用，现在已经被 <a href="http://www.passportjs.org/guide/oauth2-api/" target="_blank" rel="noopener noreferrer">OAuth 2.0</a>。建议将新的实施基于 OAuth 2.0。</p><p>当使用 OAuth 去保护 API 端点时，必须执行三个不同的步骤：</p><ol><li>应用向用户请求许可来访问被保护资源。</li><li>如果用户授权许可，token 将发送给应用。</li><li>应用使用 token 认证来访问被保护资源。</li></ol><h3 id="发送-token" tabindex="-1"><a class="header-anchor" href="#发送-token"><span>发送 Token</span></a></h3><p><a href="https://github.com/jaredhanson/oauthorize" target="_blank" rel="noopener noreferrer">OAuthorize</a>，Passport 的一个同级项目，提供了一个实现 OAuth 提供者服务的工具包。</p><p>认证过程是一个复杂的队列，涉及同时认证请求应用和用户，还有提示用户许可，确保提供了足够的细节给用户做知情的决定。</p><p>除此之外，由实现者来决定可以在应用程序上对访问范围设置哪些限制，以及随后实施这些限制。</p><p>作为工具包，OAuthorize 没有视图实现这个决定。这个指南不包括这个问题，但是强烈建议部署 OAuth 服务需要全面了解涉及的安全注意事项。</p><h3 id="认证-token" tabindex="-1"><a class="header-anchor" href="#认证-token"><span>认证 Token</span></a></h3><p>一旦发送，OAuth token 能够使用 <a href="https://github.com/jaredhanson/passport-http-oauth" target="_blank" rel="noopener noreferrer">passport-http-oauth</a> 模块认证。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">npm install passport<span class="token operator">-</span>http<span class="token operator">-</span>oauth</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="配置-2" tabindex="-1"><a class="header-anchor" href="#配置-2"><span>配置</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">passport<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&#39;token&#39;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TokenStrategy</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">consumerKey<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        Consumer<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">key</span><span class="token operator">:</span> consumerKey <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> consumer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>consumer<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> consumer<span class="token punctuation">,</span> consumer<span class="token punctuation">.</span>secret<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">accessToken<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        AccessToken<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">token</span><span class="token operator">:</span> accessToken <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> token</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            Users<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token comment">// 第四个参数是可选项 info。通常用来传入需要授权请求的详细信息</span></span>
<span class="line">                <span class="token comment">// （例如：\`scope\`）</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">,</span> token<span class="token punctuation">.</span>secret<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">scope</span><span class="token operator">:</span> token<span class="token punctuation">.</span>scope <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 如果需要可以验证时间戳和随机数</span></span>
<span class="line">        <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>和其他策略相比，OAuth 需要两个回调。在 OAuth 中，用于请求应用的标识和用户定义的 token 都会编码作为凭证。</p><p>第一个回调是“消费者”回调，用来找到发出请求的应用，包括分配给它的密钥。第二个回调是“token 回调”，用户标识用户和 token 对应的密钥。密钥有消费者提供，token 回调用来计算签名，如果和请求的签名不匹配那么认证失败。</p><p>最后一个“验证回调”是可选的，通过检查时间戳和请求使用的随机数来组织重播攻击。</p><h3 id="保护端点-2" tabindex="-1"><a class="header-anchor" href="#保护端点-2"><span>保护端点</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/api/me&#39;</span><span class="token punctuation">,</span> </span>
<span class="line">    passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&#39;token&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">session</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>token</code> 策略中定义 <code>passport.authenticate()</code> 来保护 API 端点。sessions 通常不被API 需要，所以能够禁止。</p><h2 id="oauth-2-0" tabindex="-1"><a class="header-anchor" href="#oauth-2-0"><span>OAuth 2.0</span></a></h2><p>OAuth 2.0（<a href="http://tools.ietf.org/html/rfc6749" target="_blank" rel="noopener noreferrer">RFC 6749</a> 正式定义）提供了授权框架，允许用户授予访问权限给第三方应用。当授权后，应用将发送一个 token 作为 认证凭证使用。这有两点主要的安全好处：</p><ol><li>应用不需要存储用户的用户名和密码。</li><li>token 能够有一个严格限制的授权范围（例如：只读权限）。</li></ol><p>这些好处对于确保 web 应用的安全和使 OAuth 2.0 成为占主导地位的 API 认证标准尤其重要。</p><p>当使用 OAuth 2.0 保护 API 端点时，必须执行三个不同的步骤：</p><ol><li>应用向用户请求许可来访问被保护资源。</li><li>如果用户授权许可，token 将发送给应用。</li><li>应用使用 token 认证来访问被保护资源。</li></ol><h3 id="发送-token-1" tabindex="-1"><a class="header-anchor" href="#发送-token-1"><span>发送 token</span></a></h3><p><a href="https://github.com/jaredhanson/oauth2orize" target="_blank" rel="noopener noreferrer">OAuth2orize</a>，Passport 的一个同级项目，提供了一个实现 OAuth 2.0 认证服务的工具包。</p><p>认证过程是一个复杂的队列，涉及同时认证请求应用和用户，还有提示用户许可，确保提供了足够的细节给用户做知情的决定。</p><p>除此之外，由实现者来决定可以在应用程序上对访问范围设置哪些限制，以及随后实施这些限制。</p><p>作为工具包，OAuth2orize 没有视图实现这个决定。这个指南不包括这个问题，但是强烈建议部署 OAuth 2.0 服务需要全面了解涉及的安全注意事项。</p><h3 id="认证-token-1" tabindex="-1"><a class="header-anchor" href="#认证-token-1"><span>认证 token</span></a></h3><p>OAuth 2.0 提供了一个框架，可以在其中发布可任意扩展的 token 集合。实际上，只有特定的 token 类型得到广泛使用。</p><h3 id="bearer-token-不记名-token" tabindex="-1"><a class="header-anchor" href="#bearer-token-不记名-token"><span>Bearer token （不记名 token）</span></a></h3><p>Bearer token 是 OAuth 2.0 中最广泛发行的 token 类型。事实上，许多实现假定 bearer token 是唯一发行的 token 类型。</p><p>Bearer token 能够使用 <a href="https://github.com/jaredhanson/passport-http-bearer" target="_blank" rel="noopener noreferrer">passport-http-bearer</a> 模块认证。</p><h3 id="安装-1" tabindex="-1"><a class="header-anchor" href="#安装-1"><span>安装</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">npm install passport<span class="token operator">-</span>http<span class="token operator">-</span>bearer</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="配置-3" tabindex="-1"><a class="header-anchor" href="#配置-3"><span>配置</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">passport<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BearerStrategy</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">token<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">token</span><span class="token operator">:</span> token <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token string">&#39;read&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">)</span>  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>bearer token 的验证回调接受 <code>token</code> 作为参数。当调用 <code>done</code> 方法时，可选的 <code>info</code> 参数能够被传入，将被设置在 <code>req.authInfo</code> 属性上。这个通常用来传达 token 的作用域，并且可以在进行访问控制检查时使用。</p><h3 id="保护端点-3" tabindex="-1"><a class="header-anchor" href="#保护端点-3"><span>保护端点</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/api/me&#39;</span><span class="token punctuation">,</span> </span>
<span class="line">    passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&#39;bearer&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">session</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用 <code>bearer</code> 策略指定 <code>passport.authenticate()</code> 方法来保护 API 端点。API 常不使用 session，所以可以禁止。</p><h2 id="api-方案" tabindex="-1"><a class="header-anchor" href="#api-方案"><span>API 方案</span></a></h2><p>下面的策略列表实现了当保护 API 端点时用到的认证方案。</p><table><thead><tr><th>方案</th><th>规定</th><th>开发者</th></tr></thead><tbody><tr><td><a href="https://github.com/jaredhanson/passport-anonymous" target="_blank" rel="noopener noreferrer">Anonymous</a></td><td>N/A</td><td><a href="https://github.com/jaredhanson" target="_blank" rel="noopener noreferrer">Jared Hanson</a></td></tr><tr><td><a href="https://github.com/jaredhanson/passport-http-bearer" target="_blank" rel="noopener noreferrer">Bearer</a></td><td><a href="http://tools.ietf.org/html/rfc6750" target="_blank" rel="noopener noreferrer">RFC 6750</a></td><td><a href="https://github.com/jaredhanson" target="_blank" rel="noopener noreferrer">Jared Hanson</a></td></tr><tr><td><a href="https://github.com/jaredhanson/passport-http" target="_blank" rel="noopener noreferrer">Basic</a></td><td><a href="http://tools.ietf.org/html/rfc2617" target="_blank" rel="noopener noreferrer">RFC 2617</a></td><td><a href="https://github.com/jaredhanson" target="_blank" rel="noopener noreferrer">Jared Hanson</a></td></tr><tr><td><a href="https://github.com/jaredhanson/passport-http" target="_blank" rel="noopener noreferrer">Digest</a></td><td><a href="http://tools.ietf.org/html/rfc2617" target="_blank" rel="noopener noreferrer">RFC 2617</a></td><td><a href="https://github.com/jaredhanson" target="_blank" rel="noopener noreferrer">Jared Hanson</a></td></tr><tr><td><a href="https://github.com/yuri-karadzhov/passport-hash" target="_blank" rel="noopener noreferrer">Hash</a></td><td>N/A</td><td><a href="https://github.com/yuri-karadzhov" target="_blank" rel="noopener noreferrer">Yuri Karadzhov</a></td></tr><tr><td><a href="https://github.com/jfromaniello/passport-hawk" target="_blank" rel="noopener noreferrer">Hawk</a></td><td><a href="https://github.com/hueniverse/hawk" target="_blank" rel="noopener noreferrer">hueniverse/hawk</a></td><td><a href="https://github.com/jfromaniello" target="_blank" rel="noopener noreferrer">José F. Romaniello</a></td></tr><tr><td><a href="https://github.com/cholalabs/passport-localapikey" target="_blank" rel="noopener noreferrer">Local API Key</a></td><td>N/A</td><td><a href="https://github.com/cholalabs" target="_blank" rel="noopener noreferrer">Sudhakar Mani</a></td></tr><tr><td><a href="https://github.com/jaredhanson/passport-http-oauth" target="_blank" rel="noopener noreferrer">OAuth</a></td><td><a href="http://tools.ietf.org/html/rfc5849" target="_blank" rel="noopener noreferrer">RFC 5849</a></td><td><a href="https://github.com/jaredhanson" target="_blank" rel="noopener noreferrer">Jared Hanson</a></td></tr><tr><td><a href="https://github.com/jaredhanson/passport-oauth2-client-password" target="_blank" rel="noopener noreferrer">OAuth 2.0 Client Password</a></td><td><a href="http://tools.ietf.org/html/rfc6749#section-2.3.1" target="_blank" rel="noopener noreferrer">RFC 6749</a></td><td><a href="https://github.com/jaredhanson" target="_blank" rel="noopener noreferrer">Jared Hanson</a></td></tr><tr><td><a href="https://github.com/xtuple/passport-oauth2-jwt-bearer" target="_blank" rel="noopener noreferrer">OAuth 2.0 JWT Client Assertion</a></td><td><a href="http://tools.ietf.org/html/draft-jones-oauth-jwt-bearer" target="_blank" rel="noopener noreferrer">draft-jones-oauth-jwt-bearer</a></td><td><a href="https://github.com/xtuple" target="_blank" rel="noopener noreferrer">xTuple</a></td></tr><tr><td><a href="https://github.com/timshadel/passport-oauth2-public-client" target="_blank" rel="noopener noreferrer">OAuth 2.0 Public Client</a></td><td><a href="http://tools.ietf.org/html/rfc6749" target="_blank" rel="noopener noreferrer">RFC 6749</a></td><td><a href="https://github.com/timshadel" target="_blank" rel="noopener noreferrer">Tim Shadel</a></td></tr><tr><td>s</td><td></td><td></td></tr></tbody></table><h2 id="感谢阅读" tabindex="-1"><a class="header-anchor" href="#感谢阅读"><span>感谢阅读</span></a></h2><p>感谢你阅读到这里，翻译的不好的地方，还请指点。希望我的内容能让你受用，再次感谢。<a href="https://llccing.github.io/FrontEnd/" target="_blank" rel="noopener noreferrer">by llccing 千里</a></p>`,76)])])}const i=s(t,[["render",o]]),r=JSON.parse('{"path":"/lib/nestjs/passport/03-apis.html","title":"[译]Passport 文档（三）基本 & 摘要","lang":"zh-CN","frontmatter":{},"git":{"updatedTime":1768212680000,"contributors":[{"name":"Rowan Liu","username":"","email":"lcf33123@gmail.com","commits":1}],"changelog":[{"hash":"8dc20e2f1b4b500b4a8b691792c2c9b3c12addca","time":1768212680000,"email":"lcf33123@gmail.com","author":"Rowan Liu","message":"Merge pull request #66 from llccing/copilot/fix-vite-build-error"}]},"filePathRelative":"lib/nestjs/passport/03-apis.md"}');export{i as comp,r as data};
