import{_ as s,c as a,a as e,o as p}from"./app-Dbw06csz.js";const t={};function o(c,n){return p(),a("div",null,[...n[0]||(n[0]=[e(`<h1 id="译-passport-文档-二-提供者" tabindex="-1"><a class="header-anchor" href="#译-passport-文档-二-提供者"><span>[译]Passport 文档（二）提供者</span></a></h1><p><a href="http://www.passportjs.org/docs/downloads/html/" target="_blank" rel="noopener noreferrer">http://www.passportjs.org/docs/downloads/html/</a> 原文地址</p><h2 id="facebook" tabindex="-1"><a class="header-anchor" href="#facebook"><span>Facebook</span></a></h2><p>Facebook 策略允许用户使用他们的 Facebook 账户登录一个 web 应用。在内部，Facebook 认证使用 OAuth 2.0 进行工作。</p><p>Facebook 支持通过 <a href="https://github.com/jaredhanson/passport-facebook" target="_blank" rel="noopener noreferrer">passport-facebook</a> 模块实现。</p><h3 id="安装" tabindex="-1"><a class="header-anchor" href="#安装"><span>安装</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">npm install passport<span class="token operator">-</span>facebook</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="配置" tabindex="-1"><a class="header-anchor" href="#配置"><span>配置</span></a></h3><p>使用 Facebook 认证前，你必须在 <a href="https://developers.facebook.com/" target="_blank" rel="noopener noreferrer">Facebook 开发者平台</a> 创建一个应用。创建完成后，这个应用会有 App ID 和 App Secret。你的应用也必须实现一个重定向 URL，当用户批准了你的应用访问权限后，Facebook 会将用户重定向到该 URL。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;passport&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    FaceBookStrategy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;passport-facebook&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Strategy<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">passport<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FaceBookStrategy</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">clientID</span><span class="token operator">:</span> <span class="token constant">FACEBOOK_APP_ID</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">clientSecret</span><span class="token operator">:</span> <span class="token constant">FACEBOOK_APP_SECRET</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">callbackURL</span><span class="token operator">:</span> <span class="token string">&#39;http://www.example.com/auth/facebook/callback&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">accessToken<span class="token punctuation">,</span> refreshToken<span class="token punctuation">,</span> profile<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    User<span class="token punctuation">.</span><span class="token function">findOrCreate</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Facebook 认证的验证回调接受 <code>accessToken</code>，<code>refreshToken</code> 和 <code>profile</code> 参数。<code>profile</code> 参数将包含 Facebook 提供的用户个人信息。查看 <a href="http://www.passportjs.org/guide/profile/" target="_blank" rel="noopener noreferrer">User Profile</a> 了解更多信息。</p><p>注意：为了安全，重定向 URL 必须和在 Facebook 注册的是相同主机名。（译者注：不包含协议和端口）</p><h3 id="路由" tabindex="-1"><a class="header-anchor" href="#路由"><span>路由</span></a></h3><p>Facebook 认证需要两个路由。第一个重定向用户到 Facebook。第二个是个URL，Facebook 将在用户登录后，将用户重定向到该 URL。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 重定向用户到 Facebook 认证。当认证完成后，</span></span>
<span class="line"><span class="token comment">// Facebook 将重定向用户到应用：</span></span>
<span class="line"><span class="token comment">// /auth/facebook/callback</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/auth/facebook&#39;</span><span class="token punctuation">,</span> passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&#39;facebook&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 批准后，Facebook 将重定向用户到这个 URL。</span></span>
<span class="line"><span class="token comment">// 通过尝试获取访问 token 来结束认证过程。</span></span>
<span class="line"><span class="token comment">// 如果已授权，用户将登录。</span></span>
<span class="line"><span class="token comment">// 否则，认证失败。</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/auth/facebook/callback&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&#39;facebook&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">successRedirect</span><span class="token operator">:</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">failureRedirect</span><span class="token operator">:</span> <span class="token string">&#39;/login&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意，回调的 URL 需要匹配配置策略时指定的 <code>callbackURL</code> 选项。</p><h3 id="权限" tabindex="-1"><a class="header-anchor" href="#权限"><span>权限</span></a></h3><p>如果你的应用需要扩展权限，可以通过设置 <code>scope</code> 选项来请求该权限。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/auth/facebook&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&#39;facebook&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token string">&#39;read_stream&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>多个权限可以定义为数组。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/auth/facebook&#39;</span><span class="token punctuation">,</span> </span>
<span class="line">    passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&#39;facebook&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;read_stream&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;publish_actions&#39;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="链接" tabindex="-1"><a class="header-anchor" href="#链接"><span>链接</span></a></h3><p>页面上的一个链接或者按钮，允许点击登录 Facebook。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;/auth/facebook&quot;</span> <span class="token operator">&gt;</span>登录 Facebook<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="twitter" tabindex="-1"><a class="header-anchor" href="#twitter"><span>Twitter</span></a></h2><p>Twitter 策略允许用户使用他们的 Twitter 账户登录一个 web 网站。在内部，Twitter 认证使用 OAuth 1.0a 进行工作。</p><p>Twitter 支持通过 <a href="https://github.com/jaredhanson/passport-twitter" target="_blank" rel="noopener noreferrer">passport-twitter</a> 模块实现。</p><h3 id="安装-1" tabindex="-1"><a class="header-anchor" href="#安装-1"><span>安装</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">npm install passport<span class="token operator">-</span>twitter</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="配置-1" tabindex="-1"><a class="header-anchor" href="#配置-1"><span>配置</span></a></h3><p>使用 Twitter 认证前，你首先需要在 <a href="https://dev.twitter.com/" target="_blank" rel="noopener noreferrer">Twitter 开发者平台</a> 创建应用。创建完成后，应用会被授予一个 消费者 key 和 消费者 secret。你的应用必须实现一个回调 URL，当用户为你的应用授权后，Twitter 将重定向用户到该 URL。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;passport&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    TwitterStrategy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;passport-twitter&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Strategy<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">passport<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TwitterStrategy</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">consumerKey</span><span class="token operator">:</span> <span class="token constant">TWITTER_CONSUMER_KEY</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">consumerSecret</span><span class="token operator">:</span> <span class="token constant">TWITTER_CONSUMER_SECRET</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">callbackURL</span><span class="token operator">:</span> <span class="token string">&#39;http://www.example.com/auth/twitter/callback&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">token<span class="token punctuation">,</span> toeknSecret<span class="token punctuation">,</span> profile<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    User<span class="token punctuation">.</span><span class="token function">findOrCreate</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Twitter 认证的验证回调接受 <code>token</code>，<code>tokenSecret</code> 和 <code>profile</code> 参数。<code>profile</code> 包含 Twitter 提供的用户个人信息。查看 <a href="http://www.passportjs.org/guide/profile/" target="_blank" rel="noopener noreferrer">User Profile</a> 了解更多详细信息</p><h3 id="路由-1" tabindex="-1"><a class="header-anchor" href="#路由-1"><span>路由</span></a></h3><p>Twitter 认证需要两个路由。第一个是初始化一个 OAuth 交换和重定向用户到 Twitter。第二个用户登录成功后，Twitter 将重定向用户到该 URL。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 重定向用户到 Twitter 认证。认证完成后</span></span>
<span class="line"><span class="token comment">// Twitter 将重定向用户到应用：</span></span>
<span class="line"><span class="token comment">// /auth/twitter/callback</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/auth/twitter&#39;</span><span class="token punctuation">,</span> passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&#39;twitter&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 批准后，Twitter 将重定向用户到这个 URL。</span></span>
<span class="line"><span class="token comment">// 通过尝试获取访问 token 来结束认证过程。</span></span>
<span class="line"><span class="token comment">// 如果已授权，用户将登录。</span></span>
<span class="line"><span class="token comment">// 否则，认证失败。</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/auth/twitter/callback&#39;</span><span class="token punctuation">,</span> </span>
<span class="line">    passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&#39;twitter&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">successRedirect</span><span class="token operator">:</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">failureRedirect</span><span class="token operator">:</span> <span class="token string">&#39;/login&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意，回调的 URL 需要匹配配置策略时指定的 <code>callbackURL</code> 选项。</p><h3 id="链接-1" tabindex="-1"><a class="header-anchor" href="#链接-1"><span>链接</span></a></h3><p>页面上的一个链接或者按钮，允许点击登录 Twitter。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;/auth/facebook&quot;</span> <span class="token operator">&gt;</span>登录 Twitter<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="google" tabindex="-1"><a class="header-anchor" href="#google"><span>Google</span></a></h2><p>Google 策略允许用户使用 Google 账户登录一个 web 应用。Google <a href="https://developers.google.com/identity/protocols/OpenID2Migration#shutdown-timetable" target="_blank" rel="noopener noreferrer">过去一直在内部支持 OpenID</a>，但是现在基于 <a href="https://developers.google.com/identity/protocols/OpenIDConnect" target="_blank" rel="noopener noreferrer">OpenID Connect</a> 工作，并且支持 OAuth 1.0 和 OAuth 2.0。</p><p>Google 支持通过 <a href="https://github.com/jaredhanson/passport-google-oauth" target="_blank" rel="noopener noreferrer">passport-google-oauth</a> 模块实现。</p><h3 id="安装-2" tabindex="-1"><a class="header-anchor" href="#安装-2"><span>安装</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">npm install passport<span class="token operator">-</span>google<span class="token operator">-</span>oauth</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="配置-2" tabindex="-1"><a class="header-anchor" href="#配置-2"><span>配置</span></a></h3><p>用来去 Google 认证的 Client ID 和 Client Secret 能够在 <a href="https://console.developers.google.com/" target="_blank" rel="noopener noreferrer">Google 开发者控制台</a> 获得。你可能也需要在开发者控制台开启 Google+ API，否则用户信息可能获取不到。Google 同时支持 OAuth 1.0 和 OAuth 2.0 的认证。</p><h4 id="oauth-1-0" tabindex="-1"><a class="header-anchor" href="#oauth-1-0"><span>OAuth 1.0</span></a></h4><p>Google 的 OAuth 1.0 认证策略使用一个 Google 账户和 OAuth token 认证用户。这个策略需要一个 <code>verfiy</code> 回调，它接受这些凭证和调用 <code>done</code> 方法来提供 user。还有 <code>options</code> 参数定义了 消费者 key，消费者 secret 和回调 URL。</p><h5 id="配置-3" tabindex="-1"><a class="header-anchor" href="#配置-3"><span>配置</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;passport&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> GoogleStrategy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;passport-google-oauth&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>OAuthStrategy<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 在 Passport 中使用 Google 策略。</span></span>
<span class="line"><span class="token comment">// Passport 的策略需要一个 \`verify\` 函数，它接收凭证（本例中有：token，tokenSecret 和 Google 提供的个人信息），然后将 user 传入回调函数中。</span></span>
<span class="line">passport<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GoogleStrategy</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">consumerKey</span><span class="token operator">:</span> <span class="token constant">GOOGLE_CONSUMER_KEY</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">consumerSecret</span><span class="token operator">:</span> <span class="token constant">GOOGLE_CONSUMER_SECRET</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">callbackURL</span><span class="token operator">:</span> <span class="token string">&#39;http://www.example.com/auth/google/callback&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">token<span class="token punctuation">,</span> tokenSecret<span class="token punctuation">,</span> profile<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    User<span class="token punctuation">.</span><span class="token function">findOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">googleId</span><span class="token operator">:</span> profile<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="路由-2" tabindex="-1"><a class="header-anchor" href="#路由-2"><span>路由</span></a></h5><p>使用 passport.authenticate() 定义 Google 策略，来认证请求。Google 认证需要一个额外的 <code>scope</code> 参数。了解更多信息，请去<a href="https://developers.google.com/identity/protocols/OpenIDConnect#scope-param" target="_blank" rel="noopener noreferrer">这里</a>。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// GET /auth/google</span></span>
<span class="line"><span class="token comment">//  使用 passport.authenticate() 作为路由中间件来认证请求。Google 认证的第一步是重定向用户到 google.com。授权后，Google 将重定向用户返回应用的 /auth/google/callback 接口。</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/auth/google&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&#39;google&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token string">&#39;https://www.google.com/m8/feeds&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// GET /auth/google/callback</span></span>
<span class="line"><span class="token comment">//  使用 passport.authenticate() 作为路由中间件来认证请求。</span></span>
<span class="line"><span class="token comment">//  如果认证失败，用户将被重重定向会登录页。否则，基本路由函数将被调用，在本例中，将重定向用户到主页。</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/auth/google/callback&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&#39;google&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">failureRedirect</span><span class="token operator">:</span> <span class="token string">&#39;/login&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// 注意，这里和 passport.authenticate() 函数同级</span></span>
<span class="line">    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="oauth-2-0" tabindex="-1"><a class="header-anchor" href="#oauth-2-0"><span>OAuth 2.0</span></a></h4><p>Google OAuth 2.0 认证策略使用 Google 账户和 OAuth 2.0 token 认证用户。这个策略需要一个 <code>verify</code> 回调，它接受这些凭证和调用 <code>done</code> 方法来提供 user。还有 <code>options</code> 参数定义了 Client ID，Client secret 和回调 URL。</p><h5 id="配置-4" tabindex="-1"><a class="header-anchor" href="#配置-4"><span>配置</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;passport&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> GoogleStrategy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;passport-google-oauth&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>OAuth2Strategy<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 在 Passport 中使用 Google 策略。</span></span>
<span class="line"><span class="token comment">// Passport 的策略需要一个 \`verify\` 函数，它接收凭证（本例中有：accessToken，refreshToken 和 Google 提供的个人信息），然后将 user 传入回调函数中。</span></span>
<span class="line">passport<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GoogleStrategy</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">clientID</span><span class="token operator">:</span> <span class="token constant">GOOGLE_CLIENT_ID</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">clientSecret</span><span class="token operator">:</span> <span class="token constant">GOOGLE_CLIENT_SECRET</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">callbackURL</span><span class="token operator">:</span> <span class="token string">&#39;http://www.example.com/auth/google/callback&#39;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token comment">// 注意，OAuth 2.0 策略的配置中，function 作为策略的第二个参数</span></span>
<span class="line"><span class="token comment">// 和 OAuth 1.0 略有不同。</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">accessToken<span class="token punctuation">,</span> refreshToken<span class="token punctuation">,</span> profile<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    User<span class="token punctuation">.</span><span class="token function">findOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">google</span><span class="token operator">:</span> profile<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> user<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="路由-3" tabindex="-1"><a class="header-anchor" href="#路由-3"><span>路由</span></a></h5><p>使用 passport.authenticate() 定义 Google 策略，来认证请求。Google 认证需要一个额外的 <code>scope</code> 参数。了解更多信息，请去<a href="https://developers.google.com/identity/protocols/OpenIDConnect#scope-param" target="_blank" rel="noopener noreferrer">这里</a>。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// GET /auth/google</span></span>
<span class="line"><span class="token comment">//  使用 passport.authenticate() 作为路由中间件来认证请求。Google 认证的第一步是重定向用户到 google.com。授权后，Google 将重定向用户返回应用的 /auth/google/callback 接口。</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/auth/google&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&#39;google&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token string">&#39;https://www.googleapis.com/auth/plus.login&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// GET /auth/google/callback</span></span>
<span class="line"><span class="token comment">//  使用 passport.authenticate() 作为路由中间件来认证请求。</span></span>
<span class="line"><span class="token comment">//  如果认证失败，用户将被重重定向会登录页。否则，基本路由函数将被调用，在本例中，将重定向用户到主页。</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/auth/google/callback&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&#39;google&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">failureRedirect</span><span class="token operator">:</span> <span class="token string">&#39;/login&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// 注意，这里和 passport.authenticate() 函数同级</span></span>
<span class="line">    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="链接-2" tabindex="-1"><a class="header-anchor" href="#链接-2"><span>链接</span></a></h3><p>页面上的一个链接或者按钮，允许点击登录 Google。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;/auth/facebook&quot;</span> <span class="token operator">&gt;</span>登录 Google<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="相关地址" tabindex="-1"><a class="header-anchor" href="#相关地址"><span>相关地址</span></a></h2><ul><li><p><a href="https://www.yuque.com/yuque/developer/authorizing-oauth-apps" target="_blank" rel="noopener noreferrer">https://www.yuque.com/yuque/developer/authorizing-oauth-apps</a> 语雀 OAuth 授权</p></li><li><p><a href="https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html" target="_blank" rel="noopener noreferrer">https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html</a> 微信 OAuth2.0 接入文档</p></li><li><p><a href="https://wiki.open.qq.com/wiki/%E3%80%90QQ%E7%99%BB%E5%BD%95%E3%80%91OAuth2.0%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3" target="_blank" rel="noopener noreferrer">https://wiki.open.qq.com/wiki/%E3%80%90QQ%E7%99%BB%E5%BD%95%E3%80%91OAuth2.0%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3</a> QQ OAuth 2.0 接入文档</p></li></ul><h2 id="感谢阅读" tabindex="-1"><a class="header-anchor" href="#感谢阅读"><span>感谢阅读</span></a></h2><p>感谢你阅读到这里，翻译的不好的地方，还请指点。希望我的内容能让你受用，再次感谢。<a href="https://llccing.github.io/FrontEnd/" target="_blank" rel="noopener noreferrer">by llccing 千里</a></p>`,68)])])}const i=s(t,[["render",o]]),r=JSON.parse('{"path":"/lib/nestjs/passport/02-providers.html","title":"[译]Passport 文档（二）提供者","lang":"zh-CN","frontmatter":{},"git":{"updatedTime":1768212680000,"contributors":[{"name":"Rowan Liu","username":"","email":"lcf33123@gmail.com","commits":1}],"changelog":[{"hash":"8dc20e2f1b4b500b4a8b691792c2c9b3c12addca","time":1768212680000,"email":"lcf33123@gmail.com","author":"Rowan Liu","message":"Merge pull request #66 from llccing/copilot/fix-vite-build-error"}]},"filePathRelative":"lib/nestjs/passport/02-providers.md"}');export{i as comp,r as data};
